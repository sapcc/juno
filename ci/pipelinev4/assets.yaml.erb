# prettier-ignore
<%
  # supported asset types
  SWIFT_CONTAINER_PENDING_ASSETS = "juno-pending-assets"
  ASSETS_SOURCE = { 
    "juno-assets": ["app","lib"],
    "juno-3rd-party": ["app"],
  }
  ASSETS = {
    # "auth":                 { type: "app", path: "apps/auth" },
    # "assets-overview":      { type: "app", path: "apps/assets-overview"},
    # "user-activity":        { type: "app", path: "apps/user-activity"},
    # "volta":                { type: "app", path: "apps/volta"},
    "whois":                { type: "app", path: "apps/whois"},
    # "widget-loader":        { type: "app", path: "apps/widget-loader"},
    # "dashboard":            { type: "app", path: "apps/dashboard"},
    # "supernova":            { type: "app", path: "apps/supernova"},
    # "exampleapp":           { type: "app", path: "apps/exampleapp"},
    # "greenhouse":           { type: "app", path: "apps/greenhouse" },
    # "greenhouse-management":{ type: "app", path: "apps/greenhouse-management" },
    # "heureka":              { type: "app", path: "apps/heureka"},
    # "juno-ui-components":   { type: "lib", path: "libs/juno-ui-components"},
    # "messages-provider":    { type: "lib", path: "libs/messages-provider"},
    # "oauth":                { type: "lib", path: "libs/oauth"},
    # "policy-engine":        { type: "lib", path: "libs/policy-engine"},
    # "communicator":         { type: "lib", path: "libs/communicator"},
    # "url-state-provider":   { type: "lib", path: "libs/url-state-provider"},
    # "url-state-router":     { type: "lib", path: "libs/url-state-router"},
    # "utils":                { type: "lib", path: "libs/utils"},
  }
%>

resources:
  - name: base.image
    type: docker-image
    icon: docker
    source:
      username: ((registry-user/keppel-ccloud.username))
      password: ((registry-user/keppel-ccloud.password))
      repository: keppel.eu-de-1.cloud.sap/ccloud/juno-v3-base

  - name: ci-helper.image
    type: docker-image
    icon: docker
    source:
      username: ((registry-user/keppel-ccloud.username))
      password: ((registry-user/keppel-ccloud.password))
      repository: keppel.eu-de-1.cloud.sap/ccloud/juno-v3-ci-helper

  #- name: secrets.git
  #  type: git-proxy
  #  webhook_token: lfkhslkfhs
  #  check_every: 6h
  #  source:
  #    uri: git@github.wdf.sap.corp:cc/secrets.git
  #    branch: "master"
  #    private_key: ((github-private-key/cc-secrets))
  
  <%# ASSETS SOURCE GIT %>
  <% ASSETS.each do |name,details| %>
  - name: <%=details[:type]%>-<%= name %>.git
    type: git
    icon: github
    source:
      uri: https://github.com/sapcc/juno.git
      branch: main
      paths: ["<%=details[:path]%>","libs","package.json","e2e", ".yarn"]
      # "ci"
      # "ci/scripts"
      # "ci/shared"
      username: sapcc-bot
      password: ((github-access-token/sapcc-bot))
  
  <% end %>


groups: 
  - name: assets 
    jobs:
      <% ASSETS.each do |name,details| %>
      - build-upload-<%= details[:type] %>-<%= name %>
      <% end %>

jobs:
  # ============================================================= 
  # BUILD ASSETS IMAGES

  # Assets build
  <% ASSETS.each do |name,details| %>
  - name: build-upload-<%= details[:type] %>-<%= name %>
    public: true
    plan:
      - get: <%= details[:type] %>-<%= name %>.git
        trigger: true
      - get: base.image
      - get: ci-helper.image

      - task: build
        image: base.image
        input_mapping: 
          latest: <%= details[:type] %>-<%= name %>.git
        config:
          inputs:
            - name: latest
          outputs:
            - name: build_result
          platform: linux
          run:
            path: /bin/sh
            # NOTE use -cx for debugging, than you can see the commands that where tirggered in the log
            args:
              - -c
              - |
                set -e 
                ls -la
                # TODO: this need a lot of runtime, move that stuff into asset_build.sh after version check
                echo "sync all node_modules from /juno/ to ./latest/"
                rsync -am --include='*/' --include='node_modules/***' --exclude='*' /juno/ ./latest
                cd ./latest
                echo "update node modules -> npm install --silent"
                npm install --silent
                echo "build app <%= details[:type] %>-<%= name %> and write to build_result/"
                ./ci/scripts/asset_build.sh --asset-name <%= name %> --asset-type <%= details[:type] %> --output-path ../build_result <% if details[:type] == "lib" %> --last-build-path ../last_build <% end %>
      - task: sync-to-<%=SWIFT_CONTAINER_PENDING_ASSETS%>
        file: <%= details[:type] %>-<%= name %>.git/ci/shared/swift-upload.yaml
        input_mapping:
          upload: build_result
        params:
          ACTION: sync
          DRY_RUN: "false"
          DEBUG: "true"
          CONTAINER: "<%=SWIFT_CONTAINER_PENDING_ASSETS%>"
          ASSET_NAME: <%= name %>
          ASSET_TYPE: <%= details[:type] %>

  <% end %> 
